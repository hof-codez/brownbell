<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brown Bell Award - Season Standings</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 10px;
            padding-bottom: 120px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            color: #764ba2;
            font-size: 2em;
            margin-bottom: 5px;
        }

        .header .subtitle {
            color: #666;
            font-size: 1em;
        }

        .automation-status {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 0.9em;
        }

        .loading {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 12px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .info-bar {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .week-info {
            font-weight: bold;
            color: #764ba2;
        }

        .last-updated {
            font-size: 0.9em;
            color: #666;
        }

        .award-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .award-toggle button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: white;
            color: #666;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
        }

        .award-toggle button.active {
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .award-toggle .main-award.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .award-toggle .next-up-award.active {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .view-toggle button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: white;
            color: #666;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
        }

        .view-toggle button.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            color: #444;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .standings-table {
            width: 100%;
            border-collapse: collapse;
        }

        .standings-table th {
            background: #f0f0f0;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            color: #444;
            font-size: 0.9em;
        }

        .standings-table td {
            padding: 12px 8px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.9em;
        }

        .standings-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .rank-gold {
            background: linear-gradient(90deg, #ffd700, #ffed4e) !important;
            font-weight: bold;
        }

        .rank-silver {
            background: linear-gradient(90deg, #c0c0c0, #e0e0e0) !important;
            font-weight: bold;
        }

        .rank-bronze {
            background: linear-gradient(90deg, #cd7f32, #daa520) !important;
            font-weight: bold;
        }

        .position-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.75em;
            margin-right: 5px;
        }

        .pos-QB {
            background: #e3f2fd;
            color: #1976d2;
        }

        .pos-RB {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .pos-WR {
            background: #e8f5e9;
            color: #388e3c;
        }

        .sub-badge {
            background: #fff3cd;
            color: #856404;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 0.7em;
            font-weight: bold;
            margin-left: 3px;
        }

        .auto-sub-badge {
            background: #17a2b8;
            color: white;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 0.7em;
            font-weight: bold;
            margin-left: 3px;
        }

        .season-overview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8em;
            overflow-x: auto;
        }

        .season-overview-table th {
            background: #f0f0f0;
            padding: 8px 4px;
            text-align: center;
            font-size: 0.75em;
            min-width: 35px;
        }

        .season-overview-table td {
            padding: 6px 4px;
            text-align: center;
            border: 1px solid #e0e0e0;
            font-size: 0.75em;
        }

        .season-overview-table .team-cell {
            text-align: left;
            font-weight: bold;
            background: #f8f9fa;
            min-width: 120px;
            font-size: 0.8em;
        }

        .player-cell {
            white-space: nowrap;
        }

        .week-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .week-selector select {
            flex: 1;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-size: 1em;
            background: white;
        }

        .active-subs {
            background: #fff8dc;
            border: 1px solid #ffd700;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .active-subs h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .sub-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .table-container {
            overflow-x: auto;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
        }

        .refresh-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
                padding-bottom: 120px;
            }

            .header {
                padding: 15px;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .card {
                padding: 15px;
            }

            .standings-table th,
            .standings-table td {
                padding: 8px 4px;
                font-size: 0.8em;
            }

            .position-badge {
                font-size: 0.7em;
                padding: 1px 4px;
            }

            .season-overview-table {
                font-size: 0.7em;
            }

            .season-overview-table th,
            .season-overview-table td {
                padding: 4px 2px;
                font-size: 0.7em;
            }

            .info-bar {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>Brown Bell Award</h1>
            <div class="subtitle">Season Standings - Auto-Updated Daily</div>
        </div>

        <div class="automation-status" id="automationStatus" style="display: none;">
            Automatically updated via GitHub Actions
        </div>

        <div id="loading" class="loading">
            <div>Loading league data...</div>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="content" style="display: none;">
            <div class="info-bar">
                <div class="week-info">Current Week: <span id="currentWeek">-</span></div>
                <div class="last-updated">Last Updated: <span id="lastUpdated">-</span></div>
                <button class="refresh-btn" onclick="loadData()">Refresh</button>
            </div>

            <div id="activeSubs" class="active-subs" style="display: none;">
                <h3>Active Substitutions</h3>
                <div id="activeSubsList"></div>
            </div>

            <div class="week-selector" id="weekSelector" style="display: none;">
                <select id="weekSelect" onchange="updateWeeklyView()">
                    <option value="current">Current Week</option>
                </select>
            </div>

            <!-- Award Toggle -->
            <div class="award-toggle">
                <button id="mainAwardBtn" class="main-award active" onclick="toggleAward('main')">Brown Bell
                    Award</button>
                <button id="nextUpAwardBtn" class="next-up-award" onclick="toggleAward('nextup')">Next Up Award</button>
            </div>

            <div class="view-toggle">
                <button id="weeklyBtn" class="active" onclick="showView('weekly')">Weekly Standings</button>
                <button id="seasonBtn" onclick="showView('season')">Season Overview</button>
            </div>

            <div class="card" id="standingsCard">
                <h2 id="standingsTitle">Weekly Standings</h2>
                <div class="table-container">
                    <div id="standingsContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let appData = null;
        let currentView = 'weekly';
        let selectedWeek = 'current';
        let currentAward = 'main';

        document.addEventListener('DOMContentLoaded', function () {
            loadData();
        });

        async function loadData() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const content = document.getElementById('content');

            loading.style.display = 'block';
            error.style.display = 'none';
            content.style.display = 'none';

            try {
                const response = await fetch('./brown-bell-data.json?' + new Date().getTime());

                if (!response.ok) {
                    throw new Error(`Failed to load data: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                appData = data;

                if (data.currentAward) {
                    currentAward = data.currentAward;
                }

                if (data.lastAutomationRun) {
                    const statusDiv = document.getElementById('automationStatus');
                    const lastRun = new Date(data.lastAutomationRun);
                    statusDiv.innerHTML = `Automatically updated via GitHub Actions - Last run: ${lastRun.toLocaleDateString()} ${lastRun.toLocaleTimeString()}`;
                    statusDiv.style.display = 'block';
                }

                updateDisplay();
                loading.style.display = 'none';
                content.style.display = 'block';

            } catch (err) {
                console.error('Error loading data:', err);
                loading.style.display = 'none';
                error.style.display = 'block';
                error.innerHTML = `
                    <strong>Unable to load league data.</strong><br>
                    Error: ${err.message}<br>
                    <small>If you're viewing this locally, make sure the brown-bell-data.json file is in the same directory.</small>
                `;
            }
        }

        function toggleAward(awardType) {
            currentAward = awardType;
            document.getElementById('mainAwardBtn').classList.toggle('active', awardType === 'main');
            document.getElementById('nextUpAwardBtn').classList.toggle('active', awardType === 'nextup');
            updateDisplay();
        }

        function updateDisplay() {
            if (!appData) return;

            // Set award toggle buttons without calling toggleAward
            document.getElementById('mainAwardBtn').classList.toggle('active', currentAward === 'main');
            document.getElementById('nextUpAwardBtn').classList.toggle('active', currentAward === 'nextup');

            document.getElementById('currentWeek').textContent = appData.currentWeek || 1;

            if (appData.timestamp) {
                const date = new Date(appData.timestamp);
                document.getElementById('lastUpdated').textContent = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
            }

            const weekSelect = document.getElementById('weekSelect');
            weekSelect.innerHTML = '<option value="current">Current Week</option>';
            for (let i = 1; i <= 18; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Week ${i}`;
                weekSelect.appendChild(option);
            }
            weekSelect.value = 'current'; // Force selection to current week

            updateActiveSubstitutions();

            if (currentView === 'weekly') {
                showWeeklyStandings();
            } else {
                showSeasonOverview();
            }
        }

        function updateActiveSubstitutions() {
            const selectedWeekNum = selectedWeek === 'current' ? (appData.currentWeek || 1) : parseInt(selectedWeek);

            // Find substitutions active for the selected week
            const activeSubs = (appData.substitutions || []).filter(s =>
                s.awardType === currentAward &&
                s.startWeek <= selectedWeekNum &&
                (!s.endWeek || s.endWeek >= selectedWeekNum)
            );

            const subsCard = document.getElementById('activeSubs');
            const subsList = document.getElementById('activeSubsList');

            if (activeSubs.length === 0) {
                subsCard.style.display = 'none';
                return;
            }

            subsCard.style.display = 'block';
            subsList.innerHTML = '';

            const awardLabel = currentAward === 'nextup' ? 'Next Up Award' : 'Brown Bell Award';

            activeSubs.forEach(sub => {
                const div = document.createElement('div');
                div.className = 'sub-item';

                const subBadgeClass = sub.autoGenerated ? 'auto-sub-badge' : 'sub-badge';
                const subBadgeText = sub.autoGenerated ? 'AUTO-SUB' : 'SUB';
                const reasonText = sub.reason ? ` (${sub.reason})` : '';

                div.innerHTML = `
            <strong>${sub.teamName}</strong> <small>(${awardLabel})</small>: 
            <span class="position-badge pos-${sub.substitutePosition}">${sub.substitutePosition}</span>
            ${sub.substituteName} 
            <span class="${subBadgeClass}">${subBadgeText} for ${sub.originalName}</span>
            <br><small>Week ${sub.startWeek}-${sub.endWeek || 'Indefinite'}${reasonText}</small>
        `;
                subsList.appendChild(div);
            });
        }

        function showView(view) {
            currentView = view;

            document.getElementById('weeklyBtn').classList.toggle('active', view === 'weekly');
            document.getElementById('seasonBtn').classList.toggle('active', view === 'season');

            document.getElementById('weekSelector').style.display = view === 'weekly' ? 'flex' : 'none';

            if (view === 'weekly') {
                showWeeklyStandings();
            } else {
                showSeasonOverview();
            }
        }

        function updateWeeklyView() {
            selectedWeek = document.getElementById('weekSelect').value;
            updateActiveSubstitutions(); // Add this line
            showWeeklyStandings();
        }

        function showWeeklyStandings() {
            const week = selectedWeek === 'current' ? (appData.currentWeek || 1) : parseInt(selectedWeek);
            const title = document.getElementById('standingsTitle');
            const content = document.getElementById('standingsContent');

            const awardName = currentAward === 'nextup' ? 'Next Up Award' : 'Brown Bell Award';
            title.textContent = `Week ${week} Standings - ${awardName}`;

            const teams = currentAward === 'main' ? (appData.teams || []) : (appData.nextUpTeams || []);
            const scoresData = currentAward === 'main' ? appData.scores : appData.nextUpScores;

            const weeklyScores = [];
            teams.forEach(team => {
                const teamKey = currentAward === 'main' ? team.name : team.mainTeamName;
                const weekScores = scoresData?.[teamKey]?.[week] || {};

                const p1Score = weekScores[0] || 0;
                const p2Score = weekScores[1] || 0;
                const total = p1Score + p2Score;

                weeklyScores.push({
                    team: team,
                    p1Score,
                    p2Score,
                    total,
                    week
                });
            });

            weeklyScores.sort((a, b) => b.total - a.total);

            let html = '<table class="standings-table">';
            html += '<thead><tr>';
            html += '<th>Rank</th><th>Team</th><th>Player 1</th><th>Player 2</th><th>Total</th>';
            html += '</tr></thead><tbody>';

            weeklyScores.forEach((score, idx) => {
                const rank = idx + 1;
                let rankClass = '';
                if (rank === 1) rankClass = 'rank-gold';
                else if (rank === 2) rankClass = 'rank-silver';
                else if (rank === 3) rankClass = 'rank-bronze';

                const p1Display = getPlayerDisplayName(score.team, 0, week);
                const p2Display = getPlayerDisplayName(score.team, 1, week);

                html += `<tr class="${rankClass}">`;
                html += `<td><strong>${rank}</strong></td>`;
                html += `<td><strong>${score.team.name}</strong></td>`;
                html += `<td>${getPlayerDisplayWithCorrectBadge(score.team, 0, week, p1Display)}<br><small>${score.p1Score.toFixed(1)} pts</small></td>`;
                html += `<td>${getPlayerDisplayWithCorrectBadge(score.team, 1, week, p2Display)}<br><small>${score.p2Score.toFixed(1)} pts</small></td>`;
                html += `<td><strong>${score.total.toFixed(1)}</strong></td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            content.innerHTML = html;
        }

        function showSeasonOverview() {
            const title = document.getElementById('standingsTitle');
            const content = document.getElementById('standingsContent');

            const awardName = currentAward === 'nextup' ? 'Next Up Award' : 'Brown Bell Award';
            title.textContent = `Season Overview - ${awardName}`;

            const teams = currentAward === 'main' ? (appData.teams || []) : (appData.nextUpTeams || []);
            const scoresData = currentAward === 'main' ? appData.scores : appData.nextUpScores;

            const seasonTotals = [];
            teams.forEach(team => {
                const teamKey = currentAward === 'main' ? team.name : team.mainTeamName;
                const weeklyTotals = [];
                let seasonTotal = 0;

                for (let week = 1; week <= 18; week++) {
                    const weekScores = scoresData?.[teamKey]?.[week] || {};
                    const p1Score = weekScores[0] || 0;
                    const p2Score = weekScores[1] || 0;
                    const total = p1Score + p2Score;
                    weeklyTotals.push({ p1: p1Score, p2: p2Score, total });
                    seasonTotal += total;
                }

                seasonTotals.push({
                    team,
                    weeklyTotals,
                    seasonTotal
                });
            });

            seasonTotals.sort((a, b) => b.seasonTotal - a.seasonTotal);

            let html = '<table class="season-overview-table">';
            html += '<thead><tr>';
            html += '<th>Rank</th><th>Team</th>';
            for (let w = 1; w <= 18; w++) {
                html += `<th>W${w}</th>`;
            }
            html += '<th>Total</th>';
            html += '</tr></thead><tbody>';

            seasonTotals.forEach((data, idx) => {
                const rank = idx + 1;
                let rankClass = '';
                if (rank === 1) rankClass = 'rank-gold';
                else if (rank === 2) rankClass = 'rank-silver';
                else if (rank === 3) rankClass = 'rank-bronze';

                html += `<tr class="${rankClass}">`;
                html += `<td rowspan="2" style="vertical-align: middle;"><strong>${rank}</strong></td>`;
                html += `<td class="team-cell" rowspan="2" style="vertical-align: middle;"><strong>${data.team.name}</strong></td>`;

                for (let w = 1; w <= 18; w++) {
                    const score = data.weeklyTotals[w - 1].p1;
                    html += `<td class="player-cell">${score > 0 ? score.toFixed(1) : '-'}</td>`;
                }
                html += `<td rowspan="2" style="vertical-align: middle;"><strong>${data.seasonTotal.toFixed(1)}</strong></td>`;
                html += '</tr>';

                html += `<tr class="${rankClass}">`;
                for (let w = 1; w <= 18; w++) {
                    const score = data.weeklyTotals[w - 1].p2;
                    html += `<td class="player-cell">${score > 0 ? score.toFixed(1) : '-'}</td>`;
                }
                html += '</tr>';
            });

            html += '</tbody></table>';
            content.innerHTML = html;
        }

        function getPlayerDisplayName(team, playerIndex, week) {
            const teamName = currentAward === 'main' ? team.name : team.mainTeamName;
            const substitutions = appData.substitutions || [];
            const sub = substitutions.find(s =>
                s.teamName === teamName &&
                s.playerIndex === playerIndex &&
                s.awardType === currentAward &&
                s.startWeek <= week &&
                (!s.endWeek || s.endWeek >= week)
            );
            return sub ? sub.substituteName : team.players[playerIndex].name;
        }

        function getSubBadge(team, playerIndex, week) {
            const teamName = currentAward === 'main' ? team.name : team.mainTeamName;
            const substitutions = appData.substitutions || [];
            const sub = substitutions.find(s =>
                s.teamName === teamName &&
                s.playerIndex === playerIndex &&
                s.awardType === currentAward &&
                s.startWeek <= week &&
                (!s.endWeek || s.endWeek >= week)
            );

            if (!sub) return '';

            const badgeClass = sub.autoGenerated ? 'auto-sub-badge' : 'sub-badge';
            const badgeText = sub.autoGenerated ? 'AUTO-SUB' : 'SUB';
            return `<span class="${badgeClass}">${badgeText}</span>`;
        }

        function getPlayerDisplayWithCorrectBadge(team, playerIndex, week, displayName) {
            const teamName = currentAward === 'main' ? team.name : team.mainTeamName;
            const substitutions = appData.substitutions || [];
            const sub = substitutions.find(s =>
                s.teamName === teamName &&
                s.playerIndex === playerIndex &&
                s.awardType === currentAward &&
                s.active &&
                s.startWeek <= week &&
                (!s.endWeek || s.endWeek >= week)
            );

            // Use substitute's actual position if there's a substitution, otherwise use original player position
            const actualPosition = sub ? sub.substitutePosition : team.players[playerIndex].position;
            const positionBadge = `<span class="position-badge pos-${actualPosition}">${actualPosition}</span>`;
            const subBadge = sub ? getSubBadge(team, playerIndex, week) : '';

            return `${positionBadge} ${displayName} ${subBadge}`;
        }

    </script>
</body>

</html>